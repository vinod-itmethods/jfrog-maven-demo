name: Maven Build and Publish to Artifactory

on:
  push:
    branches: [main]

permissions:
  contents: read  # Allow read access to repo
  id-token: write # Allow OIDC authentication if needed

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Configure Maven with Artifactory
        run: |
          mkdir -p ~/.m2
          echo '<settings>
                  <mirrors>
                    <mirror>
                      <id>artifactory-maven-central</id>
                      <mirrorOf>central</mirrorOf>
                      <url>https://artifactory.stage.0658b-techopscore.com/artifactory/maven-central/</url>
                      <layout>default</layout>
                    </mirror>
                  </mirrors>
                  <servers>
                    <server>
                      <id>artifactory</id>
                      <username>${{ secrets.JFROG_USER }}</username>
                      <password>${{ secrets.JFROG_TOKEN }}</password>
                    </server>
                  </servers>
                </settings>' > ~/.m2/settings.xml

      - name: Build Project
        run: mvn clean install

      - name: Deploy to Artifactory
        run: mvn deploy -DaltDeploymentRepository=artifactory::default::https://artifactory.stage.0658b-techopscore.com/artifactory/maven-appcode-dev
