name: Maven Build and Publish to Artifactory

on:
  push:
    branches: [main]

permissions:
  contents: read  
  id-token: write  

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Install JFrog CLI
        run: |
          curl -fL https://getcli.jfrog.io | sh
          chmod +x jfrog
          mv jfrog /usr/local/bin/

      - name: Authenticate JFrog CLI using Environment Variables
        run: |
          export JFROG_CLI_OFFER_CONFIG=false
          export JFROG_CLI_LOG_LEVEL=INFO
          export JFROG_CLI_SERVER_ID=my-artifactory
          export JFROG_CLI_URL=https://artifactory.stage.0658b-techopscore.com
          export JFROG_CLI_USER=${{ secrets.JFROG_USER }}
          export JFROG_CLI_PASSWORD=${{ secrets.JFROG_TOKEN }}
          export JFROG_CLI_BUILD_NAME=maven-build
          jfrog config use my-artifactory

      - name: Set Up Maven Configuration
        run: |
          mkdir -p ~/.m2
          echo '<settings>
                  <mirrors>
                    <mirror>
                      <id>artifactory-maven-central</id>
                      <mirrorOf>central</mirrorOf>
                      <url>https://artifactory.stage.0658b-techopscore.com/artifactory/maven-central/</url>
                      <layout>default</layout>
                    </mirror>
                  </mirrors>
                  <servers>
                    <server>
                      <id>artifactory-maven-central</id>
                      <username>${{ secrets.JFROG_USER }}</username>
                      <password>${{ secrets.JFROG_TOKEN }}</password>
                    </server>
                    <server>
                      <id>artifactory</id>
                      <username>${{ secrets.JFROG_USER }}</username>
                      <password>${{ secrets.JFROG_TOKEN }}</password>
                    </server>
                  </servers>
                </settings>' > ~/.m2/settings.xml

      - name: Build Project
        run: mvn clean install

      - name: Deploy to Artifactory using JFrog CLI
        run: jfrog rt upload "target/*.jar" "maven-appcode-dev/"
